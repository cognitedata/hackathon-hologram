
<!DOCTYPE html>
<html>
<head>
    <script src="js/face-api.js"></script>
    <script src="js/commons.js"></script>
    <script src="js/drawing.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
</head>
<body>
    <div style="position: absolute; right:0; top: 0; width: 350px; height: 200px;">
        <video style="position: absolute; top: 0; width: 100%;" onplay="onPlay(this)" id="inputVideo" autoplay muted></video>
        <canvas style="position: absolute; top: 0; width: 100%; " id="overlay" />
    </div>


<script>
    let forwardTimes = []
    let withFaceLandmarks = true
    let withBoxes = true

    function updateTimeStats(timeInMs) {
        forwardTimes = [timeInMs].concat(forwardTimes).slice(0, 30)
        const avgTimeInMs = forwardTimes.reduce((total, t) => total + t) / forwardTimes.length
    }

    async function onPlay() {
        const videoEl = $('#inputVideo').get(0)
        if(videoEl.paused || videoEl.ended || !isFaceDetectionModelLoaded())
            return setTimeout(() => onPlay())
        const options = getFaceDetectorOptions()
        const ts = Date.now()
        const faceDetectionTask = faceapi.detectSingleFace(videoEl, options)
        const result = withFaceLandmarks
            ? await faceDetectionTask.withFaceLandmarks()
            : await faceDetectionTask
        updateTimeStats(Date.now() - ts)
        const drawFunction = withFaceLandmarks
            ? drawLandmarks
            : drawDetections
        if (result) {
            drawFunction(videoEl, $('#overlay').get(0), [result], withBoxes)
        }
        setTimeout(() => onPlay())
    }


    const TINY_FACE_DETECTOR = 'tiny_face_detector'
    let selectedFaceDetector =  TINY_FACE_DETECTOR

    // tiny_face_detector options
    let inputSize = 128
    let scoreThreshold = 0.5

    function getFaceDetectorOptions() {
        return new faceapi.TinyFaceDetectorOptions({ inputSize, scoreThreshold })
    }

    function getCurrentFaceDetectionNet() {
            return faceapi.nets.tinyFaceDetector
    }

    function isFaceDetectionModelLoaded() {
        return !!getCurrentFaceDetectionNet().params
    }

    async function changeFaceDetector(detector) {
        selectedFaceDetector = detector
        if (!isFaceDetectionModelLoaded()) {
            await getCurrentFaceDetectionNet().load('models/')
        }
    }
    async function run() {
        // load face detection and face landmark models
        await changeFaceDetector(TINY_FACE_DETECTOR)
        await faceapi.loadFaceLandmarkModel('models/')
        // await faceapi.loadFaceLandmarkTinyModel('models/tiny_face_detector_model-weights_manifest.json');

        // try to access users webcam and stream the images
        // to the video element
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} })
        const videoEl = $('#inputVideo').get(0)
        videoEl.srcObject = stream
    }

    function updateResults() {}

    $(document).ready(function() {
        run()
    })
</script>
</body>
</html>
